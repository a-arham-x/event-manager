<!-- views/home.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Home</title>
    <link rel="stylesheet" href="/CSS/home.css">
</head>
<script>
    if (!localStorage.getItem("user-token")){
        window.location.href = "/"
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<body>
    <header>
        <h1>Welcome, <%= user.name %>!</h1>
        <button onclick="logOut()" class="logout-btn">Logout</button>
    </header>
    <main>
        <section class="events-section">
            <h2>Events</h2>
            <!-- Display events here -->
            <% events.forEach(event => { %>
                <div class="event">
                    <h3><%= event.eventName %></h3>
                    <p>Date: <%= event.datetime.slice(0, 10) %></p>
                    <p>Time: <%= event.datetime.slice(11, 19) %></p>
                    <% if (event.details) { %>
                        <p>Description: <%= event.details %></p>
                    <% } %>
                    <p>Location: <%= event.location %></p>
                    <% if (event.weather) { %>
                        <p>Weather: <%= event.weather %></p>
                    <% } %>
                    <% if (event.approved) { %>
                        <p>Event is approved</p>
                    <% } %>
                </div>
            <% }); %>
        </section>
        <section class="create-event-section">
            <h2>Create Event</h2>
            <div>
                <div class="form-group">
                    <label for="eventName">Event Name</label>
                    <input type="text" id="eventName" name="eventName" required>
                </div>
                <div class="form-group">
                    <label for="eventDate">Event Date</label>
                    <input type="date" id="eventDate" name="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventTime">Event Time</label>
                    <input type="time" id="eventTime" name="eventTime" required>
                </div>
                <div class="form-group">
                    <label for="eventLocation">Event Location (City)</label>
                    <input type="text" id="eventLocation" name="eventLocation" required>
                </div>
                <div class="form-group">
                    <label for="eventLocation">Event Details</label>
                    <input type="text" id="eventDetails" name="eventDetails">
                </div>
                <button onclick="createCustomEvent()">Create Event</button>
            </div>
        </section>
    </main>
</body>
<script>
    function logOut(){
        localStorage.setItem("user-token", "")
        window.location.href = "/"
    }
    async function createCustomEvent(){
        const eventName = document.getElementById("eventName").value;
        const datetime = document.getElementById("eventDate").value + "T" + document.getElementById("eventTime").value + ":00"
        const location = document.getElementById("eventLocation").value;
        const details = document.getElementById("eventDetails").value;
        $.ajax({
            url: "/api/events",
            method: "POST",
            headers: {
                "Content-type": "application/json",
                "user-token": localStorage.getItem("user-token")
            },
            data: JSON.stringify({eventName, datetime, location, details}),
            success: function(response) {
                if (response.success) {
                    const newEvent = response.event;
                    if (newEvent.weather){
                        const eventHtml = `
                        <div class="event">
                            <h3>${newEvent.eventName}</h3>
                            <p>Date: ${newEvent.datetime.slice(0, 10)}</p>
                            <p>Time: ${newEvent.datetime.slice(11, 19)}</p>
                            <p>Location: ${newEvent.location}</p>
                            <p>Weather: ${newEvent.weather}</p>
                        </div>`;
                        $('.events-section').append(eventHtml);
                        alert(response.message);
                    }  else{
                        const eventHtml = `
                        <div class="event">
                            <h3>${newEvent.eventName}</h3>
                            <p>Date: ${newEvent.datetime.slice(0, 10)}</p>
                            <p>Time: ${newEvent.datetime.slice(11, 19)}</p>
                            <p>Location: ${newEvent.location}</p>
                        </div>`;
                    } 
                    $('.events-section').append(eventHtml);
                    alert(response.message);
                }
            },
            error: function(xhr, status, error) {
                alert("Error: " + error);
            }
        });
    }
</script>
</html>

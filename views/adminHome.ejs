<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/CSS/admin.css">
    <script>
        if (!localStorage.getItem("admin-token")){
            window.location.href = "/"
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <button onclick="logOut()" class="top-right">Log Out</button>
    <button onclick="toggleCreateAdminForm()" class="top-right" style="margin-right: 100px;">Create Admin</button>
    <button onclick="viewUsers()" class="top-right" style="margin-right: 240px;">Users</button>

    <h1>Welcome to Admin Dashboard, <%= admin.name %></h1>

    <div id="events">
        <section class="events-section">
            <h2>Events</h2>
            <!-- Display events here -->
            <% events.forEach(event => { %>
                <div class="event" id="event-<%= event.id %>">
                    <h3><%= event.eventName %></h3>
                    <p>Date: <%= event.datetime.slice(0, 10) %></p>
                    <p>Time: <%= event.datetime.slice(11, 19) %></p>
                    <p>Location: <%= event.location %></p>
                    <% if (event.weather) { %>
                        <p>Weather: <%= event.weather %></p>
                    <% } %>
                    <% if (event.approved) { %>
                        <p>Event is approved</p>
                    <% } else { %>
                        <button id="button-<%= event.id %>" style="display:inline;" class="approve-btn" onclick="approveEvent('<%= event.id %>')">Approve</button>
                    <% } %>
                    <button class="delete-btn" onclick="deleteEvent('<%= event.id %>')">Delete</button>
                </div>
            <% }); %>
        </section>
    </div>

    <!-- Other sections for registrations and discussions -->

    <div id="createAdminForm" class="create-admin-form">
        <button onclick="toggleCreateAdminForm()" class="close-btn">&times;</button>
        <h2>Create New Admin</h2>
        <div>
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required>
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
            <button onclick="createAdmin()">Create Admin</button>
        </div>
    </div>

    <script>
       // admin.js
       function viewUsers(){
        window.location.href='/viewusers'
       }
        function logOut(){
         localStorage.setItem("admin-token", "");
            window.location.href = "/";
        }

        function toggleCreateAdminForm() {
            var form = document.getElementById("createAdminForm");
            if (form.style.display === "block") {
             form.style.display = "none";
            } else {
              form.style.display = "block";
            }
}
function logOut(){
        localStorage.setItem("admin-token", "")
        window.location.href = "/"
    }
    async function approveEvent(id){
        $.ajax({
            url: `/api/events/${id}/approve`,
            method: "PUT",
            headers: {
                "admin-token": localStorage.getItem("admin-token")
            },
            success: function(response) {
                if (response.success) {
                    $(`#event-${id}`).append("<p>Event is approved</p>")
                    const approveButton = $(`#button-${id}`);
                    approveButton.style.display="none";
                }
                window.alert(response.message);
            },
            error: function(xhr, status, error) {
                console.error('Error approving event:', error);
                window.alert('An error occurred while approving the event.');
            }
        });
    }
    async function deleteEvent(id){
        $.ajax({
            url: `/api/events/${id}`,
            method: "DELETE",
            headers: {
                "admin-token": localStorage.getItem("admin-token")
            },
            success: function(response) {
                if (response.success) {
                    $(`#event-${id}`).remove();
                }
                window.alert(response.message);
            },
            error: function(xhr, status, error) {
                console.error('Error approving event:', error);
                window.alert('An error occurred while approving the event.');
            }
        });
    }
    async function createAdmin(){
        const name = document.getElementById('name').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const response = await fetch("/api/admin", {
            method: "POST",
            headers: {
                "Content-type": "application/json",
                "admin-token": localStorage.getItem('admin-token')
            }, 
            body: JSON.stringify({ name, username, email, password })
        })
        const json = await response.json();
        toggleCreateAdminForm();
        window.alert(json.message);
    }
    </script>
</body>
</html>
